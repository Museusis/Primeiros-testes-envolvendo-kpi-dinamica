<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala B</title>
    <link rel="stylesheet" href="./css/dashboard.css">
    <script src="./js/menuSalaB.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


</head>
<body>
  <style>
   span {
    width: 80%;
  }
</style>

      <!-- Começo do Header -->
      <div class="header">
        <div class="container">
          <img class="logoNav" src="./img/logo_navBar.png" />
    
          <div class="menu">
            <img onclick="clickmenu()" id="menu" src="./img/menu_icon.png">
        </div>
    
        <a href="../login.html"> <button onclick="btnCadastro()" class="btnCadastro">
          Sair
        </button></a>
    
        </div>
      </div>
      <!-- Fim do Header -->
    <div id="mensagem"></div>
    <div class="container">
        <div class="cima">
    <div class="sala">
        <h1>Sala B</h1>
        <p>Monitore por cada quadrante:</p>
        <div class="btn">
          <button><a href='quadrante.html'>Quadrante 1</a> </button>
          <button><a href='quadrante2.html'>Quadrante 2</a> </button>
          <button><a href='quadrante3.html'>Quadrante 3</a> </button>
          <button><a href='quadrante4.html'>Quadrante 4</a> </button>
</div>
    </div>
    <div class="kpei">
        <div class="box" id="box1">
            <span>
                Quadrante com a maior variação de temperatura ou umidade.
        </span>
        <h3>
            Quadrante 2
        </h3></div>
        <div class="box" id="box2">
            <span>
                Porcentagem de quadrantes em conformidade com os limites ideais de temperatura e umidade:
        </span>
        <h3>
            12%
        </h3>
    </div>
</div>
    
</div>
<div class="baixo">
    <div class="graficos">
        <div>
            <canvas id="myChart1"></canvas>
          </div>
          <!-- <div>
            <canvas id="myChart2"></canvas>
          </div>
          <div>
            <canvas id="myChart3"></canvas>
          </div>
          <div>
            <canvas id="myChart4"></canvas>
          </div> -->
    </div>
</div>
</div>

</body>
</html>

<script>

// para pegar dados do banco 

let proximaAtualizacao;

  window.onload = obterDadosGraficos();

  function obterDadosGraficos() {
    obterDadosGrafico(1)
    obterDadosGrafico(2)
    obterDadosGrafico(3)
    obterDadosGrafico(4)
  }

  // O gráfico é construído com três funções:
  // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
  // 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
  // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

  // Esta função obterDadosGrafico busca os últimos dados inseridos em tabela de medidas.
  // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
  // A função obterDadosGrafico também invoca a função plotarGrafico

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function obterDadosGrafico() {

if (proximaAtualizacao != undefined) {
  clearTimeout(proximaAtualizacao);
}

fetch(`/medidas/ultimas/${idRegistro}`, { cache: 'no-store' }).then(function (response) {
  if (response.ok) {
    response.json().then(function (resposta) {
      console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
      resposta.reverse();

      plotarGrafico(resposta, idRegistro);
    });
  } else {
    console.error('Nenhum dado encontrado ou erro na API');
  }
})
  .catch(function (error) {
    console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
  });
}

function plotarGrafico(resposta, idRegistro) {

console.log('iniciando plotagem do gráfico...');

// Criando estrutura para plotar gráfico - labels
let labels = [];

// Criando estrutura para plotar gráfico - dados
let dados = {
  labels: labels,
  datasets: [{
    label: 'Umidade',
    data: [],
    fill: false,
    borderColor: 'rgb(75, 192, 192)',
    tension: 0.1
  },
  {
    label: 'Temperatura',
    data: [],
    fill: false,
    borderColor: 'rgb(199, 52, 52)',
    tension: 0.1
  }]
};

console.log('----------------------------------------------')
console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
console.log(resposta)

// Inserindo valores recebidos em estrutura para plotar o gráfico
for (i = 0; i < resposta.length; i++) {
  var registro = resposta[i];
  labels.push(registro.momento_grafico);
  dados.datasets[0].data.push(registro.umidade);
  dados.datasets[1].data.push(registro.temperatura);
}

console.log('----------------------------------------------')
console.log('O gráfico será plotado com os respectivos valores:')
console.log('Labels:')
console.log(labels)
console.log('Dados:')
console.log(dados.datasets)
console.log('----------------------------------------------')

// Criando estrutura para plotar gráfico - config
const config = {
  type: 'line',
  data: dados,
};

// Adicionando gráfico criado em div na tela
let myChart1 = new Chart(
  document.getElementById(`myChart1${idRegistro}`),
  config
);


console.log('----------------------------------------------')
console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
console.log(resposta)


setTimeout(() => atualizarGrafico(idRegistro, dados, myChart1), 1000);
}

</script>